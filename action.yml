name: 'HeadVer Tag Action'
description: 'Generate semantic version using HeadVer format and create git tag'
inputs:
  identifier:
    description: 'Optional custom identifier prefix for tag (e.g., "olym-api" results in "olym-api-0.2532.1")'
    required: false
    default: ''
  dry-run:
    description: 'If true, calculate version and tag without actually creating/pushing the tag'
    required: false
    default: 'false'
outputs:
  version:
    description: 'Generated version in HeadVer format'
    value: ${{ steps.headver.outputs.version }}
  tag:
    description: 'Generated full tag name'
    value: ${{ steps.headver.outputs.tag }}
  release_notes:
    description: 'Release notes generated from commit messages between previous and current tag'
    value: ${{ steps.headver.outputs.release_notes }}
runs:
  using: "composite"
  steps:
    - name: Generate HeadVer build version from git tag
      id: headver
      shell: bash
      run: |
        git fetch --tags
        HEAD=0
        YEARWEEK=$(date +%y)$(date +%V)
        
        # Custom identifierê°€ ì œê³µë˜ë©´ íƒœê·¸ prefixì— í¬í•¨
        if [[ -n "${{ inputs.identifier }}" ]]; then
          TAG_PREFIX="${{ inputs.identifier }}-"
          echo "[DEBUG] Custom Identifier: ${{ inputs.identifier }}"
        else
          TAG_PREFIX="v"
        fi
        
        echo "[DEBUG] íƒœê·¸ ê²€ìƒ‰ íŒ¨í„´: ${TAG_PREFIX}$HEAD.$YEARWEEK.*"
        echo "[DEBUG] í˜„ì¬ê¹Œì§€ì˜ íƒœê·¸ ëª©ë¡:"
        git tag --list "${TAG_PREFIX}$HEAD.$YEARWEEK.*" | sort -V
        
        # ê°€ì¥ í° ë¹Œë“œ ë„˜ë²„ë¥¼ ì°¾ìŒ
        LAST_BUILD=$(git tag --list "${TAG_PREFIX}$HEAD.$YEARWEEK.*" | awk -F. '{print $3}' | sort -nr | head -n1)
        echo "[DEBUG] LAST_BUILD: $LAST_BUILD"
        if [[ -z "$LAST_BUILD" ]]; then
          BUILD=1
        else
          BUILD=$((LAST_BUILD + 1))
        fi
        VERSION="$HEAD.$YEARWEEK.$BUILD"
        FINAL_TAG="${TAG_PREFIX}${VERSION}"
        echo "[DEBUG] ìµœì¢… ìƒì„±ë  ë²„ì „: $VERSION"
        echo "[DEBUG] ìµœì¢… ìƒì„±ë  íƒœê·¸: $FINAL_TAG"
        # ì´ì „ íƒœê·¸ ì°¾ê¸° (ê°™ì€ ì£¼ì˜ ì´ì „ ë¹Œë“œ ë˜ëŠ” ì´ì „ ì£¼ì˜ ë§ˆì§€ë§‰ ë¹Œë“œ)
        PREVIOUS_TAG=""
        if [[ -n "$LAST_BUILD" ]]; then
          # ê°™ì€ ì£¼ì— ì´ì „ ë¹Œë“œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
          PREVIOUS_BUILD=$((LAST_BUILD - 1))
          if [[ $PREVIOUS_BUILD -gt 0 ]]; then
            PREVIOUS_TAG="${TAG_PREFIX}$HEAD.$YEARWEEK.$PREVIOUS_BUILD"
          fi
        fi
        
        # ê°™ì€ ì£¼ì— ì´ì „ ë¹Œë“œê°€ ì—†ìœ¼ë©´ ì´ì „ ì£¼ì˜ ë§ˆì§€ë§‰ ë¹Œë“œë¥¼ ì°¾ê¸°
        if [[ -z "$PREVIOUS_TAG" ]]; then
          PREV_WEEK=$((10#$YEARWEEK - 1))
          PREV_YEARWEEK=$(printf "%02d%02d" $(date -d "$(date +%Y)-W$(printf "%02d" $PREV_WEEK)-1" +%y) $PREV_WEEK)
          PREV_LAST_BUILD=$(git tag --list "${TAG_PREFIX}$HEAD.$PREV_YEARWEEK.*" | awk -F. '{print $3}' | sort -nr | head -n1)
          if [[ -n "$PREV_LAST_BUILD" ]]; then
            PREVIOUS_TAG="${TAG_PREFIX}$HEAD.$PREV_YEARWEEK.$PREV_LAST_BUILD"
          fi
        fi
        
        echo "[DEBUG] ì´ì „ íƒœê·¸: $PREVIOUS_TAG"
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        RELEASE_NOTES=""
        if [[ -n "$PREVIOUS_TAG" ]]; then
          echo "[DEBUG] ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì§‘ ì¤‘: $PREVIOUS_TAG..HEAD"
          COMMITS=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --no-merges)
          if [[ -n "$COMMITS" ]]; then
            RELEASE_NOTES="## ë³€ê²½ì‚¬í•­"$'\n\n'"$COMMITS"
          else
            RELEASE_NOTES="## ë³€ê²½ì‚¬í•­"$'\n\n'"- ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
        else
          echo "[DEBUG] ì²« ë²ˆì§¸ íƒœê·¸ì…ë‹ˆë‹¤. ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤."
          COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          if [[ -n "$COMMITS" ]]; then
            RELEASE_NOTES="## ë³€ê²½ì‚¬í•­"$'\n\n'"$COMMITS"
          else
            RELEASE_NOTES="## ë³€ê²½ì‚¬í•­"$'\n\n'"- ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
        fi
        
        echo "[DEBUG] ìƒì„±ëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
        echo "$RELEASE_NOTES"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_ENV
        echo "tag=$FINAL_TAG" >> $GITHUB_OUTPUT
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "version=$VERSION"
    
    - name: Create and push custom tag
      if: ${{ inputs.dry-run != 'true' }}
      uses: mathieudutour/github-tag-action@v6.1
      with:
        custom_tag: ${{ steps.headver.outputs.tag }}
        tag_prefix: ""
        github_token: ${{ env.GITHUB_TOKEN }}

    - name: Dry run summary
      if: ${{ inputs.dry-run == 'true' }}
      shell: bash
      run: |
        echo "::notice::ğŸƒ Dry run mode - tag was NOT created"
        echo "::notice::ğŸ“¦ Version: ${{ steps.headver.outputs.version }}"
        echo "::notice::ğŸ·ï¸ Tag: ${{ steps.headver.outputs.tag }}"
        echo ""
        echo "=== Dry Run Summary ==="
        echo "Version: ${{ steps.headver.outputs.version }}"
        echo "Tag: ${{ steps.headver.outputs.tag }}"
        echo "This tag would be created and pushed if dry-run was disabled."